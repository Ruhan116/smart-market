# Django Backend Deployment Guide

This guide covers deploying the Smart Market Django backend to **Render** or **Railway**.

## Prerequisites

- GitHub account with your repository pushed
- Render or Railway account (free tier available)

---

## Option 1: Deploy to Render (Recommended)

### Step 1: Prepare Your Repository

✅ All necessary files are already in place:
- `render.yaml` - Infrastructure as Code configuration
- `build.sh` - Build script for migrations and static files
- `runtime.txt` - Python version specification
- `requirements.txt` - Updated with gunicorn and whitenoise

### Step 2: Create a Render Account

1. Go to https://render.com and sign up
2. Connect your GitHub account

### Step 3: Deploy Using Blueprint (Easiest Method)

1. Go to Render Dashboard
2. Click **"New +"** → **"Blueprint"**
3. Connect your GitHub repository
4. Render will detect `render.yaml` and show:
   - Web Service: `smart-market-backend`
   - PostgreSQL Database: `smart-market-db`
5. Click **"Apply"**

### Step 4: Configure Environment Variables

Render will auto-generate `DJANGO_SECRET_KEY` and `DATABASE_URL`. You need to add:

In your web service settings → Environment:

```
DJANGO_SECRET_KEY=<auto-generated>
DJANGO_DEBUG=False
DATABASE_URL=<auto-generated from database>
ALLOWED_HOSTS=your-app-name.onrender.com
CORS_ALLOWED_ORIGINS=https://your-frontend-domain.vercel.app,https://your-frontend-domain.com
```

### Step 5: Manual Deploy Alternative

If you prefer manual setup instead of Blueprint:

1. **Create PostgreSQL Database:**
   - Dashboard → New + → PostgreSQL
   - Name: `smart-market-db`
   - Choose Free tier
   - Click Create Database
   - Copy the **Internal Database URL**

2. **Create Web Service:**
   - Dashboard → New + → Web Service
   - Connect your repository
   - Configure:
     - **Name:** smart-market-backend
     - **Region:** Choose closest to you
     - **Branch:** main
     - **Root Directory:** `backend`
     - **Runtime:** Python 3
     - **Build Command:** `./build.sh`
     - **Start Command:** `gunicorn project.wsgi:application --bind 0.0.0.0:$PORT --workers 2 --timeout 120`
   - Instance Type: Free
   
3. **Add Environment Variables** (see Step 4 above)

### Step 6: Deploy and Monitor

- Render will automatically build and deploy
- First deploy takes 3-5 minutes
- Monitor logs in the Logs tab
- Your API will be available at: `https://your-app-name.onrender.com`

### Step 7: Test Your Deployment

```bash
# Health check
curl https://your-app-name.onrender.com/api/

# Create a superuser (one-time setup)
# In Render Dashboard → Shell tab:
python manage.py createsuperuser

# Access admin
https://your-app-name.onrender.com/admin/
```

---

## Option 2: Deploy to Railway

### Step 1: Create Railway Account

1. Go to https://railway.app and sign up
2. Connect your GitHub account

### Step 2: Create New Project

1. Click **"New Project"**
2. Select **"Deploy from GitHub repo"**
3. Choose your `smart-market` repository
4. Railway will detect it's a Python project

### Step 3: Add PostgreSQL Database

1. In your project, click **"+ New"**
2. Select **"Database"** → **"Add PostgreSQL"**
3. Railway will automatically create `DATABASE_URL` variable

### Step 4: Configure Web Service

1. Click on your service
2. Go to **Settings** tab
3. Configure:
   - **Root Directory:** `backend`
   - **Start Command:** `gunicorn project.wsgi:application --bind 0.0.0.0:$PORT --workers 2 --timeout 120`
   - **Build Command:** `pip install -r requirements.txt && python manage.py collectstatic --no-input && python manage.py migrate`

### Step 5: Add Environment Variables

In service **Variables** tab, add:

```
DJANGO_SECRET_KEY=<generate-a-secure-random-key>
DJANGO_DEBUG=False
DATABASE_URL=<automatically-set-from-postgres>
ALLOWED_HOSTS=your-project.up.railway.app
CORS_ALLOWED_ORIGINS=https://your-frontend.vercel.app
PYTHON_VERSION=3.11.0
```

To generate a secure secret key:
```bash
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
```

### Step 6: Deploy

- Railway automatically deploys on every push to main
- Monitor deployment in the **Deployments** tab
- Your API will be at: `https://your-project.up.railway.app`

### Step 7: Run Initial Setup

Use Railway's built-in terminal:
1. Go to your service → **"Shell"** or **"Metrics"** → **"Service Shell"**
2. Run migrations (if not done in build):
   ```bash
   python manage.py migrate
   ```
3. Create superuser:
   ```bash
   python manage.py createsuperuser
   ```

---

## Environment Variables Reference

| Variable | Required | Description | Example |
|----------|----------|-------------|---------|
| `DJANGO_SECRET_KEY` | ✅ Yes | Django secret key for security | `django-insecure-xyz123...` |
| `DJANGO_DEBUG` | ✅ Yes | Debug mode (set to False) | `False` |
| `DATABASE_URL` | ✅ Yes | PostgreSQL connection string | `postgresql://user:pass@host:5432/db` |
| `ALLOWED_HOSTS` | ✅ Yes | Comma-separated allowed hostnames | `myapp.onrender.com` |
| `CORS_ALLOWED_ORIGINS` | ✅ Yes | Frontend domains for CORS | `https://frontend.vercel.app` |
| `PYTHON_VERSION` | ⚪ Optional | Python runtime version | `3.11.0` |

---

## Post-Deployment Checklist

- [ ] Service deployed successfully
- [ ] Database connected and migrations ran
- [ ] Admin panel accessible at `/admin/`
- [ ] API endpoints responding (test `/api/` or `/api/schema/`)
- [ ] CORS configured for frontend domain
- [ ] Superuser account created
- [ ] Frontend environment variable updated with backend URL

---

## Troubleshooting

### Build Fails
- Check logs for missing dependencies
- Ensure `requirements.txt` is up to date
- Verify Python version compatibility

### Database Connection Issues
- Confirm `DATABASE_URL` is set correctly
- Check database is running (separate service)
- Verify SSL settings in production

### Static Files Not Loading
- Ensure `collectstatic` runs in build command
- Check `STATIC_ROOT` and `STATIC_URL` settings
- Verify WhiteNoise middleware is enabled

### CORS Errors
- Add your frontend domain to `CORS_ALLOWED_ORIGINS`
- Ensure no trailing slashes in URLs
- Check middleware order (CORS should be first)

### 500 Errors
- Set `DJANGO_DEBUG=True` temporarily to see detailed errors
- Check application logs in dashboard
- Verify all required environment variables are set

---

## Connecting Frontend

Update your frontend environment variables (in Vercel):

```env
VITE_API_URL=https://your-backend.onrender.com
# or
VITE_API_URL=https://your-backend.up.railway.app
```

Then update CORS in backend:
```
CORS_ALLOWED_ORIGINS=https://your-frontend.vercel.app
```

---

## Continuous Deployment

Both Render and Railway support automatic deployments:

- **Render:** Auto-deploys on push to main branch
- **Railway:** Auto-deploys on push to connected branch

To disable auto-deploy:
- Render: Service Settings → Build & Deploy → Auto-Deploy (toggle)
- Railway: Service Settings → Triggers → Enable/disable GitHub trigger

---

## Cost Estimate

### Render Free Tier
- Web Service: Free (spins down after 15 min of inactivity)
- PostgreSQL: Free (expires after 90 days)
- **Upgrade:** Starter ($7/month for web + $7/month for DB)

### Railway Free Tier
- $5 free credit/month
- Typically enough for small projects
- **Upgrade:** Pay-as-you-go ($0.000231/GB-hour)

---

## Next Steps

1. Deploy backend to Render or Railway
2. Update frontend environment variables
3. Test end-to-end integration
4. Set up monitoring (optional)
5. Configure custom domain (optional)

---

## Support

- Render Docs: https://render.com/docs
- Railway Docs: https://docs.railway.app
- Django Deployment: https://docs.djangoproject.com/en/4.2/howto/deployment/

